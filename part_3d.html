
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>OMG Particles!</title>
    <script type="text/javascript" src="d3.js"></script>
    <style type="text/css">

body {
  background: #222;
}

circle {
  fill: none;
  stroke-width: 1.5px;
}

#container {
  width: 960px;
  margin: 0 auto;
}

    </style>
  </head>
  <body>
    <div id="container">
    </div>
    <script type="text/javascript">

function rotx(v, ang) {
    var c = Math.cos(ang)
    var s = Math.sin(ang)
    return {
      x: v.x,
      y: v.y*c - v.z*s,
      z: v.z*c + v.y*s
    }
}

var w = 960,
    h = 500,
    z = d3.scale.category20c(),
    i = 0;

var w2 = w/2;
var h2 = h/2;

var svg = d3.select("#container").append("svg:svg")
    .attr("width", w)
    .attr("height", h)
    .style("pointer-events", "all")
    //.on("mousemove", particle);
    .on("mousedown", particle);

var canvas = document.createElement('canvas');

var NPART = 100;
var time = 0;
var viz_logo = new Image();
viz_logo.src = "logo.png";

var world= new Image();
world.src = "mundo.png";

function ParticleSystem() {

  var particles = [];
  var target = [];


  this.particles = particles;
  this.target = target;

  function morph_to(t) {
    if(t.length >= particles.length) {
      var d = t.length - particles.length;
      for(var i = 0; i < d; ++i) {
        var ang = randf()*2*Math.PI;
        particles.push({
          x: 500*Math.cos(ang),
          y: 500*Math.sin(ang),
          z: 0
        });
      }
    } else {
      particles = particles.slice(0, t.length);
    }
    target = t;
  }

  this.custom_update = function(p) { return p };
  function update(time) {
    var custom_update = this.custom_update;
    for(var i = 0; i < particles.length; ++i) {
      var p = particles[i];
      var tp = target[i];
      tp = target[i] = custom_update(tp, time);
      p.x += (tp.x + Math.cos(time+i) - p.x)*0.1;
      p.y += (tp.y + Math.sin(time+i)- p.y)*0.1;
      p.z += (tp.z - p.z)*0.1;
      
    }
  }

  function morph_to_image(img, x, y, map) {
    var px = get_pixels_for(function(ctx) {
        ctx.fillStyle = '#FFF';
        ctx.drawImage(img, x, y);
    });
    var new_target = [];
    for(var i = 0; i < px.length; ++i) {
      var p = px[i];
      if(map) {
        p = map(p);
      }
      new_target[i] = {
        x: 5*p.x,
        y: 5*p.y,
        z: 5*p.z
      }
    }
    morph_to(new_target);
  }

  function morph_to_text(text, x, y) {
    var px = get_pixels_for(function(ctx) {
        ctx.fillStyle = '#FFF';
        //#ctx.fillRect(0,0, 20, 20);
        ctx.font = '20px sans-serif';
        ctx.fillText(text, x, y);
    });
    var new_target = [];
    for(var i = 0; i < px.length; ++i) {
      var p = px[i];
      new_target[i] = {
        x: 5*p.x,
        y: 5*p.y,
        z: 5*p.z
      }
    }
    morph_to(new_target);
  }

  function render(svg) {
    svg.selectAll('circle').
      data(particles)
      .enter()
        .append("svg:circle")
          .attr('r', 5)
          .attr('cx', function(p) {return w2+p.x})
          .attr('cy', function(p){ return h2+p.y})
          .style("fill", '#FFF')
          .style("fill-opacity", 0.6)

    svg.selectAll('circle').
      data(particles)
      .exit()
          .remove()

    svg.selectAll('circle').
      data(particles)
      .attr('r', function(p) {
        //return 300/(130 + p.z);
          return 1;
      })
      .attr('cx', function(p) {
        //return w2+p.x
        return w2 + 130*p.x/(130 + p.z)
       })
      .attr('cy', function(p){ 
          //return h2+p.y
          return h2 + 130*p.y/(130 + p.z)
          })
  }

  this.update = update;
  this.morph_to_text = morph_to_text;
  this.morph_to_image = morph_to_image;
  this.render = render;
  return this;
}

var pixeltoLatLon = function (point) {
    var me = this;
    var origin = me.pixelOrigin_;
    var lng = 2*Math.PI*(point.x - 50)/100;
    var latRadians = Math.PI*(50 + point.y - 23)/46.0;
    //console.log(point.y, latRadians);
    /*var lat = (2*Math.atan(Math.exp(latRadians)) -
        Math.PI / 2);*/
    var lat = latRadians;
    return {lat: lat, lng: lng}
}

function get_pixels_for(f) {
  var CSIZE = 100;
  var CSIZE2 = CSIZE/2;
  var pixels = [];
  document.body.appendChild(canvas);
  var ctx = canvas.getContext('2d');
  canvas.width = CSIZE;
  canvas.height = CSIZE;
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, CSIZE, CSIZE);
  f(ctx);
  var px = ctx.getImageData(0, 0, CSIZE, CSIZE).data;
  for(var i=0; i < CSIZE*CSIZE*4; i+=4) {
    if(px[i] > 0) {
      var jj = i/4;
      pixels.push({
        x: jj%CSIZE - CSIZE2,
        y: ((jj/CSIZE)>>0) - CSIZE2
      })
    }
  }
  return pixels;
}


function init_() {
  for(var i = 0; i < NPART; ++i) {
    var phase = 2*Math.PI*i/NPART;
    particles[i] = {
      x: 100*Math.cos(phase),
      y: 100*Math.sin(phase),
      z: 0
    }
  }
}


var textPart = new ParticleSystem();

function init() {

  textPart.morph_to_text('javi', 10, 30);
  setTimeout(function() {
    //morph_to_text('hola', 10, 30);
    textPart.custom_update = function(p, time) {
      return rotx(p, time*0.001);
    }
    textPart.morph_to_image(world, 0, 0, function(p) {
      var polar = pixeltoLatLon(p);
      var R = 10;
      var r = R*Math.cos(-polar.lat);
      var p = {
        x: r*Math.sin(polar.lng),
        y: r*Math.cos(polar.lng),
        z: R*Math.sin(-polar.lat)
      }
      return p;
    });
  }, 2000)

  return;
  setTimeout(function() {
    textPart.morph_to_text('que tal?', 10, 30);
  }, 5000)
  setTimeout(function() {
    textPart.morph_to_text('somos vizzuality', 10, 30);
  }, 8000)
}

function randf() { 
  return 0.5*(Math.random()*2 - 1)
}
function rand_step() {
  return randf() < 0 ? 1: -1;
}

init();

setInterval(function() {
    time += 0.03;
    textPart.update(time);
    textPart.render(svg);
}, 20);

function particle() {
  morph_to_text('javi', 10, 20);
}

    </script>
  </body>
</html>

